<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Compliance Issue Management Training</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: "Warm Neutral Harmony" - A calming palette with a light beige background (#F5F5DC), warm gray text (#4A4A4A), deep blue for primary actions/headings (#003366), and a subtle gold accent (#D4AF37) for highlights and interactive states. -->
    <!-- Application Structure Plan: A thematic, single-page dashboard structure was chosen over a linear slide format to promote user-driven exploration. The layout uses a main navigation bar to jump to four core sections: "Foundations," "Process," "Impact & Action," and "Roles." This allows users to either follow a logical flow or directly access information relevant to their immediate questions (e.g., a manager jumping to "Roles"). Key interactions include clickable process flow diagrams, hover-to-reveal details on role cards, and an interactive chart for impact assessment. This non-linear design enhances usability by empowering the user to control their learning path, making the content more digestible and accessible than a fixed presentation. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Core Principles (Accountability, etc.) -> Goal: Inform -> Viz: Icon-based feature cards -> Interaction: Static display -> Justification: Clear, concise introduction to core concepts. -> Library/Method: HTML/Tailwind.
        - Report Info: Escalation Process -> Goal: Organize/Change -> Viz: Interactive Flowchart Diagram -> Interaction: Clickable steps to reveal detailed descriptions -> Justification: Transforms a static process into an engaging, step-by-step exploration, improving comprehension and retention. -> Library/Method: HTML/Tailwind/JS.
        - Report Info: Impact Ratings -> Goal: Compare -> Viz: Interactive Bar Chart -> Interaction: Hover over bars to see detailed descriptions -> Justification: Visualizes the hierarchy of risk more effectively than a list and provides immediate context on hover. -> Library/Method: Chart.js.
        - Report Info: Roles & Responsibilities -> Goal: Organize -> Viz: Interactive Role Cards -> Interaction: Hover to reveal detailed responsibilities -> Justification: Presents a clean overview of all roles while allowing users to drill down into specifics without cluttering the initial view. -> Library/Method: HTML/Tailwind.
        - CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F9FA;
            color: #343A40;
        }
        .nav-link {
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        .nav-link.active, .nav-link:hover {
            color: #003366;
            border-bottom-color: #003366;
        }
        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .process-step {
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #ADB5BD;
        }
        .process-step.active {
            background-color: #E9ECEF;
            border-left-color: #003366;
        }
        .role-card .details {
            display: none;
        }
        .role-card:hover .details {
            display: block;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 50vh;
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: transform 0.3s ease;
        }
        /* Quiz Styles */
        .question-block {
            border-left: 4px solid #E9ECEF;
        }
        .question-block.incorrect {
            border-left-color: #DC3545;
            background-color: #F8D7DA;
        }
        .question-block.correct {
            border-left-color: #28A745;
            background-color: #D4EDDA;
        }
    </style>
</head>
<body class="antialiased">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-[#003366]">Compliance Issue Management</h1>
            <div class="hidden md:flex space-x-8">
                <a href="#foundations" class="nav-link active">Foundations</a>
                <a href="#process" class="nav-link">The Process</a>
                <a href="#impact" class="nav-link">Impact & Action</a>
                <a href="#roles" class="nav-link">Roles & Responsibilities</a>
                <a href="#knowledge-test" class="nav-link">Knowledge Test</a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-12">

        <section id="foundations" class="mb-20 text-center">
            <h2 class="text-4xl font-bold mb-4 text-[#003366]">Your Guide to a Culture of Compliance</h2>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto mb-12">This training is our blueprint for handling compliance issues. It's designed to empower every employee with the knowledge to act responsibly and protect our company by fostering a culture of accountability and transparency.</p>
            
            <div class="grid md:grid-cols-4 gap-8">
                <div class="card bg-white p-6 rounded-lg shadow">
                    <h3 class="font-bold text-xl mb-2 text-[#003366]">Accountability</h3>
                    <p class="text-gray-600">Ensuring someone is responsible for fixing every issue.</p>
                </div>
                <div class="card bg-white p-6 rounded-lg shadow">
                    <h3 class="font-bold text-xl mb-2 text-[#003366]">Transparency</h3>
                    <p class="text-gray-600">Providing a single, central record of all compliance issues.</p>
                </div>
                <div class="card bg-white p-6 rounded-lg shadow">
                    <h3 class="font-bold text-xl mb-2 text-[#003366]">Timely Action</h3>
                    <p class="text-gray-600">Addressing problems quickly to prevent them from escalating.</p>
                </div>
                <div class="card bg-white p-6 rounded-lg shadow">
                    <h3 class="font-bold text-xl mb-2 text-[#003366]">Risk Mitigation</h3>
                    <p class="text-gray-600">Protecting our company from financial, legal, and reputational damage.</p>
                </div>
            </div>
        </section>

        <section id="process" class="mb-20">
            <h2 class="text-3xl font-bold text-center mb-12 text-[#003366]">The Escalation Process: A Step-by-Step Guide</h2>
             <p class="text-lg text-gray-600 max-w-3xl mx-auto mb-12 text-center">The issue management process follows a clear, structured path from discovery to closure. Your primary responsibility is timely reporting within <strong>two business days</strong>. Click on each step below to learn more about what happens at each stage and what is required.</p>
            <div class="flex flex-col md:flex-row gap-8">
                <div class="md:w-1/3">
                    <div id="step1" class="process-step p-4 mb-2 active">
                        <h3 class="font-bold text-lg">1. Discovery & Escalation</h3>
                        <p class="text-sm text-gray-500">You find an issue and report it.</p>
                    </div>
                    <div id="step2" class="process-step p-4 mb-2">
                        <h3 class="font-bold text-lg">2. Qualification</h3>
                        <p class="text-sm text-gray-500">Compliance reviews your submission.</p>
                    </div>
                    <div id="step3" class="process-step p-4">
                        <h3 class="font-bold text-lg">3. Closure</h3>
                        <p class="text-sm text-gray-500">The issue is validated and closed.</p>
                    </div>
                </div>
                <div class="md:w-2/3 bg-white p-8 rounded-lg shadow-lg">
                    <div id="step1-content">
                        <h3 class="text-2xl font-bold mb-4 text-[#003366]">Discovery & Escalation</h3>
                        <p class="mb-4">A compliance issue is any gap between our practices and laws, regulations, or policies. It can be an <strong>Internal Mistake</strong>, a <strong>Customer Complaint</strong>, or a <strong>Regulatory Finding</strong>.</p>
                        <p class="mb-4 font-semibold">Your responsibility is to report any potential issue to the Compliance Department within <span class="text-[#003366]">2 business days</span> of discovery.</p>
                        <div class="bg-gray-100 p-4 rounded-md">
                            <h4 class="font-bold mb-2">Your escalation must include:</h4>
                            <ul class="list-disc list-inside text-gray-700">
                                <li>Discovery Date</li>
                                <li>Description of the issue</li>
                                <li>Proposed Issue Owner</li>
                                <li>Initial Action Plan (if any)</li>
                                <li>Regulatory Contact (if applicable)</li>
                            </ul>
                        </div>
                    </div>
                    <div id="step2-content" class="hidden">
                        <h3 class="text-2xl font-bold mb-4 text-[#003366]">Qualification</h3>
                        <p class="mb-4">After you escalate an issue, the Compliance Department reviews the submission to determine if it officially qualifies as a compliance issue.</p>
                        <p>This ensures that all reported items are properly assessed and directed to the correct channels for resolution, maintaining the integrity of our formal issue tracking system.</p>
                    </div>
                    <div id="step3-content" class="hidden">
                        <h3 class="text-2xl font-bold mb-4 text-[#003366]">Closure</h3>
                        <p class="mb-4">An issue is not closed until the fix has been validated. The approval path depends on the issue's origin:</p>
                        <ul class="list-none space-y-3">
                            <li class="flex items-start"><span class="font-bold text-[#003366] w-32 shrink-0">Regulatory Issue:</span> Requires review and approval by the Risk and Governance Committee (RGC).</li>
                            <li class="flex items-start"><span class="font-bold text-[#003366] w-32 shrink-0">Audit Function Issue:</span> The Audit Function must review and validate the fix.</li>
                            <li class="flex items-start"><span class="font-bold text-[#003366] w-32 shrink-0">All Other Issues:</span> The Compliance Department is responsible for final review and closure.</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="text-center mt-8">
                <button id="openScenarioModal" class="bg-[#003366] text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90 transition-colors">
                    ✨ Analyze a Scenario with AI
                </button>
            </div>
        </section>

        <section id="impact" class="mb-20">
            <h2 class="text-3xl font-bold text-center mb-4 text-[#003366]">Impact Assessment & Action Plan</h2>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto mb-12 text-center">Once an issue is qualified, it's assigned an impact rating to prioritize the response. The Issue Owner is then responsible for creating a robust Action Plan. Hover over the bars in the chart to see what each rating means.</p>
            <div class="flex flex-col lg:flex-row gap-8 items-center mb-12">
                <div class="lg:w-1/2 w-full">
                    <div class="chart-container">
                        <canvas id="impactChart"></canvas>
                    </div>
                </div>
                <div class="lg:w-1/2 w-full bg-white p-8 rounded-lg shadow-lg">
                    <h3 class="text-2xl font-bold mb-4 text-[#003366]">Building an Action Plan</h3>
                    <p class="mb-4">The <strong>Issue Owner</strong> is responsible for developing a detailed Action Plan. This plan is the roadmap to resolution and must be approved by the Compliance Department.</p>
                    <div class="space-y-4">
                        <div class="p-4 bg-gray-50 rounded-md">
                            <h4 class="font-semibold">1. Define Clear Actions</h4>
                            <p class="text-sm text-gray-600">Outline the specific steps that will be taken to fix the problem.</p>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-md">
                            <h4 class="font-semibold">2. Assign an Action Owner</h4>
                            <p class="text-sm text-gray-600">Designate a specific person responsible for completing each action.</p>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-md">
                            <h4 class="font-semibold">3. Set a Target Completion Date</h4>
                            <p class="text-sm text-gray-600">Establish a realistic deadline for the resolution.</p>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-md">
                            <h4 class="font-semibold">4. Address the Root Cause</h4>
                            <p class="text-sm text-gray-600">Ensure the plan fixes the underlying problem, not just the symptom.</p>
                        </div>
                    </div>
                </div>
            </div>
             <div class="bg-white p-8 rounded-lg shadow-lg">
                <h3 class="text-2xl font-bold mb-4 text-[#003366]">✨ Action Plan Assistant</h3>
                <p class="mb-4 text-gray-600">Describe a compliance issue below, and our AI assistant will help you draft a preliminary action plan.</p>
                <div class="mb-4">
                    <label for="issueDescription" class="block text-sm font-medium text-gray-700 mb-1">Issue Description</label>
                    <textarea id="issueDescription" rows="3" class="w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., A software bug caused a temporary data exposure on our client portal."></textarea>
                </div>
                <button id="generatePlanBtn" class="bg-[#003366] text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90 transition-colors">Generate Draft Action Plan</button>
                <div id="actionPlanResult" class="mt-6 hidden">
                    <h4 class="font-bold text-lg mb-2">Draft Action Plan:</h4>
                    <div id="planContent" class="bg-gray-50 p-4 rounded-md whitespace-pre-wrap"></div>
                </div>
            </div>
        </section>

        <section id="roles" class="mb-20">
            <h2 class="text-3xl font-bold text-center mb-4 text-[#003366]">Roles & Responsibilities</h2>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto mb-12 text-center">Our issue management framework operates on a three-lines-of-defense model. Everyone has a part to play in maintaining our compliance standards. Hover over each card to see the specific duties for each role.</p>
            
            <div class="mb-12">
                <h3 class="text-2xl font-bold text-center mb-6">The Three Lines of Defense</h3>
                <div class="grid md:grid-cols-3 gap-4 text-center">
                    <div class="bg-white p-6 rounded-lg border-t-4 border-[#003366]">
                        <h4 class="font-bold text-xl">1st Line: The Business (You!)</h4>
                        <p class="text-sm text-gray-600 mt-2">Responsible for identifying and escalating issues as they arise in daily operations.</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg border-t-4 border-[#6c757d]">
                        <h4 class="font-bold text-xl">2nd Line: Compliance</h4>
                        <p class="text-sm text-gray-600 mt-2">Oversees and monitors the issue management process, providing guidance and validation.</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg border-t-4 border-[#ADB5BD]">
                        <h4 class="font-bold text-xl">3rd Line: Audit Function</h4>
                        <p class="text-sm text-gray-600 mt-2">An independent function that validates our processes and internal controls.</p>
                    </div>
                </div>
            </div>

            <h3 class="text-2xl font-bold text-center mb-6">Key Roles in Focus</h3>
            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="role-card card bg-white p-6 rounded-lg shadow">
                    <h4 class="font-bold text-xl text-[#003366]">Employee</h4>
                    <p class="details mt-2 text-gray-600">Identifies and escalates potential compliance issues promptly.</p>
                </div>
                <div class="role-card card bg-white p-6 rounded-lg shadow">
                    <h4 class="font-bold text-xl text-[#003366]">Issue Owner</h4>
                    <p class="details mt-2 text-gray-600">Develops and implements the action plan to fix the issue.</p>
                </div>
                <div class="role-card card bg-white p-6 rounded-lg shadow">
                    <h4 class="font-bold text-xl text-[#003366]">Action Owner</h4>
                    <p class="details mt-2 text-gray-600">Completes specific tasks within the action plan on time.</p>
                </div>
                <div class="role-card card bg-white p-6 rounded-lg shadow">
                    <h4 class="font-bold text-xl text-[#003366]">Compliance Dept.</h4>
                    <p class="details mt-2 text-gray-600">Manages the overall process, tracks issues, and approves closures.</p>
                </div>
                <div class="role-card card bg-white p-6 rounded-lg shadow">
                    <h4 class="font-bold text-xl text-[#003366]">Chief Compliance Officer</h4>
                    <p class="details mt-2 text-gray-600">Ultimately responsible for the standard and its effective implementation.</p>
                </div>
                <div class="role-card card bg-white p-6 rounded-lg shadow">
                    <h4 class="font-bold text-xl text-[#003366]">RGC</h4>
                    <p class="details mt-2 text-gray-600">Provides oversight and approves high-risk and regulatory-related issue closures.</p>
                </div>
            </div>
        </section>
        
        <section id="knowledge-test" class="mb-20">
            <h2 class="text-3xl font-bold text-center mb-4 text-[#003366]">Knowledge Test</h2>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto mb-12 text-center">Test your understanding of the Compliance Issue Management standard. You must be signed in to take the test. A score of 80% or higher is required to pass.</p>

            <div id="test-container" class="bg-white p-8 rounded-lg shadow-lg max-w-4xl mx-auto">
                <div id="auth-section" class="text-center">
                    <p id="auth-message" class="mb-4">Authenticating... Please wait.</p>
                    
                    <div id="user-info" class="hidden">
                        <p class="mb-4">Welcome, <span id="user-name" class="font-semibold"></span>!</p>
                        <p class="text-sm text-gray-600 mb-4">Your test attempts will be logged with the email: <span id="user-email" class="font-semibold"></span></p>
                        <button id="start-test-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">Start Test</button>
                    </div>

                    <div id="anonymous-form" class="hidden">
                        <p class="mb-4">Could not sign you in automatically. Please provide your details to log your test attempt.</p>
                        <div class="max-w-sm mx-auto text-left">
                            <div class="mb-4">
                                <label for="anon-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                                <input type="text" id="anon-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#003366] focus:border-[#003366] sm:text-sm" placeholder="Jane Doe">
                            </div>
                            <div class="mb-4">
                                <label for="anon-email" class="block text-sm font-medium text-gray-700">Work Email</label>
                                <input type="email" id="anon-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#003366] focus:border-[#003366] sm:text-sm" placeholder="jane.doe@example.com">
                            </div>
                        </div>
                        <button id="start-anon-test-btn" class="mt-4 bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50" disabled>Start Test</button>
                    </div>
                </div>

                <div id="quiz-section" class="hidden">
                    <div id="quiz-questions"></div>
                    <button id="submit-quiz-btn" class="mt-8 bg-[#003366] text-white font-bold py-2 px-6 rounded-lg hover:bg-opacity-90 transition-colors">Submit Answers</button>
                </div>

                <div id="results-section" class="hidden">
                    <h3 class="text-2xl font-bold mb-4 text-center">Your Results</h3>
                    <div id="score-container" class="text-center text-4xl font-bold mb-4"></div>
                    <div id="pass-fail-message" class="text-center text-2xl font-semibold mb-8"></div>
                    <div id="results-review">
                         <h4 class="text-xl font-bold mb-4">Review Your Answers:</h4>
                         <div id="review-container" class="space-y-4"></div>
                    </div>
                    <div class="text-center mt-8">
                        <button id="retake-test-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition-colors">Retake Test</button>
                    </div>
                </div>
            </div>
        </section>

    </main>
    
    <!-- Scenario Analyzer Modal -->
    <div id="scenarioModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 modal-overlay hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-8 modal-container transform scale-95">
            <h2 class="text-2xl font-bold mb-4 text-[#003366]">✨ AI-Powered Scenario Analyzer</h2>
            <p class="mb-4 text-gray-600">Describe a potential compliance situation to get an AI-powered analysis based on our company's standards.</p>
            <textarea id="scenarioInput" class="w-full p-2 border border-gray-300 rounded-md mb-4" rows="4" placeholder="e.g., An employee accidentally emailed a sensitive client list to an external vendor..."></textarea>
            <div class="flex justify-end space-x-4">
                <button id="closeScenarioModal" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="analyzeScenarioBtn" class="bg-[#003366] text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90">Get AI Analysis</button>
            </div>
            <div id="scenarioResult" class="mt-6 hidden">
                <h3 class="font-bold text-lg mb-2">AI Analysis:</h3>
                <div id="scenarioContent" class="bg-gray-50 p-4 rounded-md whitespace-pre-wrap max-h-64 overflow-y-auto"></div>
            </div>
        </div>
    </div>


    <footer class="bg-white border-t mt-12">
        <div class="container mx-auto px-6 py-4 text-center text-gray-500">
            <p>&copy; 2025 Your Company. All Rights Reserved. For Internal Training Purposes Only.</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : { /* FALLBACK CONFIG FOR LOCAL DEV */ };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        document.addEventListener('DOMContentLoaded', function() {
            const sections = document.querySelectorAll('section');
            const navLinks = document.querySelectorAll('.nav-link');

            window.addEventListener('scroll', () => {
                let current = 'foundations';
                sections.forEach(section => {
                    const sectionTop = section.offsetTop;
                    if (pageYOffset >= sectionTop - 70) {
                        current = section.getAttribute('id');
                    }
                });

                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href').substring(1) === current) {
                        link.classList.add('active');
                    }
                });
            });
            
            navLinks.forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    document.querySelector(this.getAttribute('href')).scrollIntoView({
                        behavior: 'smooth'
                    });
                });
            });

            const steps = document.querySelectorAll('.process-step');
            const stepContents = document.querySelectorAll('[id$="-content"]');

            steps.forEach(step => {
                step.addEventListener('click', () => {
                    steps.forEach(s => s.classList.remove('active'));
                    step.classList.add('active');

                    const targetId = step.id + '-content';
                    stepContents.forEach(content => {
                        if (content.id === targetId) {
                            content.classList.remove('hidden');
                        } else {
                            content.classList.add('hidden');
                        }
                    });
                });
            });

            const ctx = document.getElementById('impactChart').getContext('2d');
            const impactData = {
                labels: ['Low', 'Low/Moderate', 'Moderate', 'Moderate/High', 'High'],
                datasets: [{
                    label: 'Impact Level',
                    data: [1, 2, 3, 4, 5],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.7)',
                        'rgba(108, 117, 125, 0.7)',
                        'rgba(255, 193, 7, 0.7)',
                        'rgba(253, 126, 20, 0.7)',
                        'rgba(220, 53, 69, 0.7)'
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(108, 117, 125, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(253, 126, 20, 1)',
                        'rgba(220, 53, 69, 1)'
                    ],
                    borderWidth: 1
                }]
            };
            const impactTooltips = [
                'Inconsequential risk. Requires minor action.',
                'Minor risk due to a weakness. Requires timely action.',
                'More than inconsequential risk due to a poorly designed control. Requires prompt action.',
                'Meaningful risk due to an absent or failed control. Requires urgent action.',
                'Significant risk (financial, legal, or reputational). Requires immediate action. Regulatory findings are automatically High Impact.'
            ];

            new Chart(ctx, {
                type: 'bar',
                data: impactData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: { display: false, beginAtZero: true },
                        y: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: function(context) { return impactTooltips[context.dataIndex]; } } }
                    }
                }
            });

            const apiKey = ""; 

            async function callGemini(userPrompt, systemPrompt) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                };

                if (systemPrompt) {
                    payload.systemInstruction = {
                        parts: [{ text: systemPrompt }]
                    };
                }

                let retries = 3;
                let delay = 1000;
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (response.ok) {
                             const result = await response.json();
                             if (result.candidates && result.candidates.length > 0) {
                                return result.candidates[0].content.parts[0].text;
                             }
                        }
                    } catch (error) { console.error("Fetch error:", error); }
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
                return "Error: Unable to get a response from the AI. Please try again later.";
            }

            const scenarioModal = document.getElementById('scenarioModal');
            const openScenarioModalBtn = document.getElementById('openScenarioModal');
            const closeScenarioModalBtn = document.getElementById('closeScenarioModal');
            const analyzeScenarioBtn = document.getElementById('analyzeScenarioBtn');
            const scenarioInput = document.getElementById('scenarioInput');
            const scenarioResult = document.getElementById('scenarioResult');
            const scenarioContent = document.getElementById('scenarioContent');

            const showModal = () => {
                scenarioModal.classList.remove('hidden');
                setTimeout(() => {
                    scenarioModal.classList.remove('opacity-0');
                    scenarioModal.querySelector('.modal-container').classList.remove('scale-95');
                }, 10);
            };
            const hideModal = () => {
                scenarioModal.querySelector('.modal-container').classList.add('scale-95');
                scenarioModal.classList.add('opacity-0');
                setTimeout(() => {
                    scenarioModal.classList.add('hidden');
                    scenarioInput.value = '';
                    scenarioResult.classList.add('hidden');
                }, 300);
            };
            openScenarioModalBtn.addEventListener('click', showModal);
            closeScenarioModalBtn.addEventListener('click', hideModal);
            scenarioModal.addEventListener('click', (e) => { if (e.target === scenarioModal) hideModal(); });

            analyzeScenarioBtn.addEventListener('click', async () => {
                const userScenario = scenarioInput.value.trim();
                if (!userScenario) return;
                analyzeScenarioBtn.disabled = true;
                analyzeScenarioBtn.textContent = 'Analyzing...';
                scenarioContent.textContent = 'Please wait...';
                scenarioResult.classList.remove('hidden');
                
                const systemPrompt = `You are a compliance expert for a company. Your task is to analyze an employee's scenario based on the company's compliance standards. The standards define a compliance issue as any gap between practices and laws/regulations/policies. Key principles are Accountability, Transparency, Timely Action, and Risk Mitigation. The escalation timeline is 2 business days.
                
                Based on the user's scenario, provide a concise analysis in three parts:
                1.  **Potential Issue:** Briefly state what the potential compliance issue is.
                2.  **Suggested Impact:** Suggest an impact level (Low, Moderate, Moderate/High, or High) and briefly justify it.
                3.  **Recommended Actions:** Provide 2-3 clear, actionable next steps the employee should take, emphasizing the 2-day escalation requirement.
                
                Format your response clearly with these three bolded headings.`;

                const resultText = await callGemini(userScenario, systemPrompt);
                scenarioContent.textContent = resultText;
                analyzeScenarioBtn.disabled = false;
                analyzeScenarioBtn.textContent = 'Get AI Analysis';
            });
            
            const generatePlanBtn = document.getElementById('generatePlanBtn');
            const issueDescriptionInput = document.getElementById('issueDescription');
            const actionPlanResult = document.getElementById('actionPlanResult');
            const planContent = document.getElementById('planContent');

            generatePlanBtn.addEventListener('click', async () => {
                const issueDescription = issueDescriptionInput.value.trim();
                if (!issueDescription) return;
                generatePlanBtn.disabled = true;
                generatePlanBtn.textContent = 'Generating...';
                planContent.textContent = 'Please wait...';
                actionPlanResult.classList.remove('hidden');
                
                const systemPrompt = `You are a compliance manager tasked with helping an Issue Owner draft an action plan. The action plan must have four key elements: Clear Actions, assigning an Action Owner, setting a Target Completion Date, and addressing the Root Cause.
                
                Based on the user's issue description, generate a draft action plan. The plan should be a numbered list of concrete steps. For each step, suggest a potential 'Action Owner' (e.g., 'IT Department', 'Marketing Manager'). Ensure the plan logically addresses the described issue and includes a final step focused on reviewing the fix to confirm the root cause has been resolved. Keep the tone professional and actionable.`;
                
                const resultText = await callGemini(issueDescription, systemPrompt);
                planContent.textContent = resultText;
                generatePlanBtn.disabled = false;
                generatePlanBtn.textContent = 'Generate Draft Action Plan';
            });

            // --- KNOWLEDGE TEST LOGIC ---
            const authSection = document.getElementById('auth-section');
            const authMessage = document.getElementById('auth-message');
            const userInfoDiv = document.getElementById('user-info');
            const anonFormDiv = document.getElementById('anonymous-form');
            const quizSection = document.getElementById('quiz-section');
            const resultsSection = document.getElementById('results-section');
            
            const startTestBtn = document.getElementById('start-test-btn');
            const startAnonTestBtn = document.getElementById('start-anon-test-btn');
            const submitQuizBtn = document.getElementById('submit-quiz-btn');
            const retakeTestBtn = document.getElementById('retake-test-btn');
            
            let userState = { name: null, email: null };

            const quizData = [
                { question: "What is the primary responsibility of an employee regarding a potential compliance issue?", options: ["Fix it immediately", "Report it within 2 business days", "Discuss it with colleagues", "Wait for the manager's instruction"], answer: "Report it within 2 business days" },
                { question: "Which of the following is considered a core principle of the compliance standard?", options: ["Profit Maximization", "Speed of Delivery", "Transparency", "Individual Recognition"], answer: "Transparency" },
                { question: "An issue discovered from a regulatory body is automatically assigned what impact rating?", options: ["Low", "Moderate", "High", "It depends on the finding"], answer: "High" },
                { question: "Who is ultimately responsible for developing and implementing an Action Plan?", options: ["The Employee who found the issue", "The Compliance Department", "The Issue Owner", "The Chief Compliance Officer"], answer: "The Issue Owner" },
                { question: "Which group provides oversight and approves closures for high-risk, regulatory-related issues?", options: ["The Board of Directors", "The Audit Function", "The Legal Department", "The Risk and Governance Committee (RGC)"], answer: "The Risk and Governance Committee (RGC)" },
                { question: "The 'First Line of Defense' in the compliance model refers to:", options: ["The Compliance Department", "The Business (All Employees)", "The Audit Function", "External Regulators"], answer: "The Business (All Employees)" },
                { question: "What is NOT a required component of an Action Plan?", options: ["Clear Actions", "A budget for the fix", "Target Completion Date", "Addressing the Root Cause"], answer: "A budget for the fix" },
                { question: "A 'compliance issue' is defined as a gap between our practices and what?", options: ["Industry best practices", "Competitor actions", "Laws, regulations, or policies", "Last quarter's performance"], answer: "Laws, regulations, or policies" },
                { question: "The 'Third Line of Defense' is described as:", options: ["A management function", "A client-facing team", "An independent function", "A project-based team"], answer: "An independent function" },
                { question: "Who is responsible for the final review and closure for most non-regulatory, non-audit issues?", options: ["The Issue Owner", "The person who found it", "The Compliance Department", "The RGC"], answer: "The Compliance Department" }
            ];

            function displayQuiz() {
                const quizQuestionsContainer = document.getElementById('quiz-questions');
                quizQuestionsContainer.innerHTML = '';
                quizData.forEach((q, index) => {
                    const questionEl = document.createElement('div');
                    questionEl.className = 'mb-6';
                    questionEl.innerHTML = `<p class="font-semibold mb-2">${index + 1}. ${q.question}</p><div class="space-y-2">${q.options.map((option, i) => `<div><input type="radio" id="q${index}o${i}" name="q${index}" value="${option}" class="mr-2"><label for="q${index}o${i}">${option}</label></div>`).join('')}</div>`;
                    quizQuestionsContainer.appendChild(questionEl);
                });
            }

            async function logTestAttempt(score, passed) {
                 if (!userState.name || !userState.email) {
                    console.error("User details not available. Cannot log attempt.");
                    return;
                }
                
                const sheetUrl = 'PASTE_YOUR_GOOGLE_APPS_SCRIPT_URL_HERE';
                
                if (sheetUrl === 'PASTE_YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                    console.warn("Google Apps Script URL not set. Skipping log.");
                    return;
                }

                const payload = {
                    name: userState.name,
                    email: userState.email,
                    score: score,
                    status: passed ? "Pass" : "Fail"
                };

                try {
                    await fetch(sheetUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } catch (e) {
                    console.error("Error logging to Google Sheet: ", e);
                }
            }

            function showResults(score) {
                const scoreContainer = document.getElementById('score-container');
                const passFailMessage = document.getElementById('pass-fail-message');
                const reviewContainer = document.getElementById('review-container');
                const passRate = 80;
                const passed = score >= passRate;

                scoreContainer.textContent = `${score}%`;
                scoreContainer.className = `text-center text-4xl font-bold mb-4 ${passed ? 'text-green-600' : 'text-red-600'}`;
                passFailMessage.textContent = passed ? "Congratulations, you passed!" : "You did not pass. Please review the material and try again.";
                passFailMessage.className = `text-center text-2xl font-semibold mb-8 ${passed ? 'text-green-600' : 'text-red-600'}`;
                
                reviewContainer.innerHTML = '';
                const userAnswers = quizData.map((q, index) => document.querySelector(`input[name="q${index}"]:checked`)?.value || null);

                quizData.forEach((q, index) => {
                    const isCorrect = userAnswers[index] === q.answer;
                    const questionBlock = document.createElement('div');
                    questionBlock.className = `p-4 rounded-md question-block ${isCorrect ? 'correct' : 'incorrect'}`;
                    
                    let reviewHTML = `
                        <p class="font-semibold">${index + 1}. ${q.question}</p>
                        <p class="text-sm">Your answer: <span class="${isCorrect ? 'text-green-800' : 'text-red-800 font-bold'}">${userAnswers[index] || 'Not answered'}</span></p>
                    `;

                    if (passed && !isCorrect) {
                        reviewHTML += `<p class="text-sm text-green-800 font-semibold">Correct answer: ${q.answer}</p>`;
                    } else if (isCorrect) {
                         reviewHTML = `<div class="p-4 rounded-md question-block correct"><p class="font-semibold">${index + 1}. ${q.question}</p><p class="text-sm">Your answer: <span class="text-green-800 font-semibold">${userAnswers[index]} (Correct)</span></p></div>`;
                    }

                    questionBlock.innerHTML = reviewHTML;
                    reviewContainer.appendChild(questionBlock);
                });

                quizSection.classList.add('hidden');
                resultsSection.classList.remove('hidden');
                logTestAttempt(score, passed);
            }
            
            onAuthStateChanged(auth, (user) => {
                if (user && !user.isAnonymous && user.displayName) {
                    userState.name = user.displayName;
                    userState.email = user.email;
                    authMessage.classList.add('hidden');
                    anonFormDiv.classList.add('hidden');
                    userInfoDiv.classList.remove('hidden');
                    document.getElementById('user-name').textContent = user.displayName;
                    document.getElementById('user-email').textContent = user.email;
                } else if (user && user.isAnonymous) {
                    authMessage.classList.add('hidden');
                    userInfoDiv.classList.add('hidden');
                    anonFormDiv.classList.remove('hidden');
                } else {
                    authMessage.textContent = "Authentication failed. Please refresh and try again.";
                    userInfoDiv.classList.add('hidden');
                    anonFormDiv.classList.add('hidden');
                }
            });

            async function initializeAuth() {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    authMessage.textContent = "Authentication failed. Please refresh and try again.";
                }
            }

            initializeAuth();

            function startTheTest() {
                authSection.classList.add('hidden');
                resultsSection.classList.add('hidden');
                displayQuiz();
                quizSection.classList.remove('hidden');
            }

            startTestBtn.addEventListener('click', startTheTest);
            startAnonTestBtn.addEventListener('click', () => {
                userState.name = document.getElementById('anon-name').value.trim();
                userState.email = document.getElementById('anon-email').value.trim();
                startTheTest();
            });
            
            const anonNameInput = document.getElementById('anon-name');
            const anonEmailInput = document.getElementById('anon-email');
            
            function validateAnonForm() {
                const name = anonNameInput.value.trim();
                const email = anonEmailInput.value.trim();
                const isEmailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
                startAnonTestBtn.disabled = !(name && isEmailValid);
            }
            anonNameInput.addEventListener('input', validateAnonForm);
            anonEmailInput.addEventListener('input', validateAnonForm);


            submitQuizBtn.addEventListener('click', () => {
                let score = 0;
                quizData.forEach((q, index) => {
                    const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                    if (selectedOption && selectedOption.value === q.answer) score++;
                });
                showResults(Math.round((score / quizData.length) * 100));
            });

            retakeTestBtn.addEventListener('click', () => {
                resultsSection.classList.add('hidden');
                authSection.classList.remove('hidden');
            });

        });
    </script>

</body>
</html>


